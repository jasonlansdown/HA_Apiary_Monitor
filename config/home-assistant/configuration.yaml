# =============================================================================
# BEE HIVE MONITORING CONFIGURATION
# Add these sections to your existing configuration.yaml
# =============================================================================

# =============================================================================
# CUSTOMIZE - Fix state_class for Python script sensors
# =============================================================================
homeassistant:
  customize:
    sensor.bee_hive_monitor_activity_score:
      state_class: measurement
      unit_of_measurement: '%'
      device_class: none
      icon: mdi:bee
    
    sensor.bee_hive_monitor_estimated_bees_per_minute:
      state_class: measurement
      unit_of_measurement: bees/min
      device_class: none
      icon: mdi:bee
    
    sensor.bee_hive_monitor_activity_level:
      icon: mdi:chart-line

# =============================================================================
# INPUT HELPERS
# =============================================================================
input_number:
  # Weight tracking
  bee_hive_weight_snapshot:
    name: "Bee Hive Weight Snapshot"
    min: 0
    max: 200
    step: 0.001
    unit_of_measurement: "kg"
    mode: box

  # Temperature alert thresholds
  bee_hive_temp_high_threshold:
    name: "Bee Hive High Temp Threshold"
    min: 90
    max: 115
    step: 1
    initial: 100
    unit_of_measurement: "°F"
    icon: mdi:thermometer-high

  bee_hive_temp_low_threshold:
    name: "Bee Hive Low Temp Threshold"
    min: 50
    max: 90
    step: 1
    initial: 85
    unit_of_measurement: "°F"
    icon: mdi:thermometer-low

# =============================================================================
# TEMPLATE SENSORS
# =============================================================================
template:
  - sensor:
      # =====================================================================
      # DAILY WEIGHT CHANGE WITH TEMPERATURE COMPENSATION
      # =====================================================================
      - name: "Bee Hive Daily Weight Change"
        unique_id: bee_hive_daily_weight_change
        unit_of_measurement: "kg"
        state_class: measurement
        device_class: weight
        icon: mdi:trending-up
        state: >
          {% set current = states('sensor.beehive_weight_compensated') | float(0) %}
          {% set snapshot = states('input_number.bee_hive_weight_snapshot') | float(current) %}
          {{ (current - snapshot) | round(3) }}
        attributes:
          snapshot_weight: "{{ states('input_number.bee_hive_weight_snapshot') }}"
          current_weight_compensated: "{{ states('sensor.beehive_weight_compensated') }}"
          current_weight_raw: "{{ states('sensor.broodminder_w_57_41_5e_weight_realtime') }}"
          temperature: "{{ states('sensor.broodminder_w_57_41_5e_temperature') }}"
          compensation_applied: "{{ states('sensor.beehive_weight_temperature_effect') }}"
          trend: >
            {% set change = this.state | float(0) %}
            {% if change > 0.5 %}Strong Gain (Nectar Flow!)
            {% elif change > 0.1 %}Gaining
            {% elif change > -0.1 %}Stable
            {% elif change > -0.5 %}Losing
            {% else %}Strong Loss (Check for Robbing!)
            {% endif %}

      # =====================================================================
      # TEMPERATURE-COMPENSATED WEIGHT
      # Reference: Calibrated 2026-02-02 for Colorado climate
      # Coefficient: -0.0558 kg/°C thermal expansion
      # =====================================================================
      - name: "Beehive Weight Compensated"
        unique_id: beehive_weight_compensated
        unit_of_measurement: "kg"
        device_class: weight
        state_class: measurement
        icon: mdi:scale
        state: >
          {% set raw_weight = states('sensor.broodminder_w_57_41_5e_weight_realtime') | float(0) %}
          {% set temperature = states('sensor.broodminder_w_57_41_5e_temperature') | float(30) %}
          
          {# Temperature compensation: -0.0558 kg per °C #}
          {# Reference temperature: 30°C (86°F) #}
          {% set temp_offset = -0.0558 * (temperature - 30) %}
          {% set compensated = raw_weight - temp_offset %}
          
          {{ compensated | round(3) }}
        availability: >
          {{ states('sensor.broodminder_w_57_41_5e_weight_realtime') not in ['unavailable', 'unknown', 'none'] and
             states('sensor.broodminder_w_57_41_5e_temperature') not in ['unavailable', 'unknown', 'none'] }}
        attributes:
          raw_weight: "{{ states('sensor.broodminder_w_57_41_5e_weight_realtime') }}"
          temperature: "{{ states('sensor.broodminder_w_57_41_5e_temperature') }}"
          temperature_offset: >
            {% set temperature = states('sensor.broodminder_w_57_41_5e_temperature') | float(30) %}
            {{ (-0.0558 * (temperature - 30)) | round(3) }}
          compensation_active: true
          calibration_date: "2026-02-02"

      # Temperature effect sensor
      - name: "Beehive Weight Temperature Effect"
        unique_id: beehive_weight_temp_effect
        unit_of_measurement: "kg"
        state_class: measurement
        state: >
          {% set temperature = states('sensor.broodminder_w_57_41_5e_temperature') | float(30) %}
          {{ (-0.0558 * (temperature - 30)) | round(3) }}
        attributes:
          description: "Estimated weight error due to temperature"

      # =====================================================================
      # SEASONAL HEALTH SCORE - COLORADO DRY CLIMATE
      # Automatically switches between Winter/Summer modes
      # Winter: External temp ≤ 50°F
      # Summer: External temp > 50°F
      # =====================================================================
      - name: "Bee Hive Health Score"
        unique_id: bee_hive_health_score
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:heart-pulse
        state: >
          {% set activity = states('sensor.bee_hive_monitor_activity_score') | float(0) %}
          {% set temp = states('sensor.broodminder_t_47_50_96_temperature') | float(0) %}
          {% set weight_change = states('sensor.bee_hive_daily_weight_change') | float(0) %}
          {% set humidity = states('sensor.broodminder_w_57_41_5e_humidity') | float(0) %}
          {% set external_temp = states('sensor.broodminder_w_57_41_5e_temperature') | float(0) %}
          
          {# Determine season based on external temperature #}
          {% set is_winter = external_temp <= 50 %}
          
          {# TEMPERATURE SCORE (0-30 points) - SEASONAL #}
          {% if is_winter %}
            {# Winter: Cluster temperatures 50-70°F optimal #}
            {% set temp_score = 30 if (temp >= 50 and temp <= 70) else (25 if (temp >= 40 and temp < 50) else (20 if (temp > 70 and temp <= 80) else (15 if (temp >= 30 and temp < 40) else (10 if (temp > 80 and temp <= 90) else 5)))) %}
          {% else %}
            {# Summer: Brood rearing 93-95°F optimal #}
            {% set temp_score = 30 if (temp >= 93 and temp <= 95) else (25 if (temp >= 90 and temp <= 97) else (15 if (temp >= 85 and temp <= 100) else (10 if (temp >= 70 and temp < 85) else 5))) %}
          {% endif %}
          
          {# ACTIVITY SCORE (0-25 points) - SEASONAL #}
          {% if is_winter %}
            {# Winter: Low activity 10-30% is normal (clustering) #}
            {% set activity_score = 25 if (activity >= 10 and activity <= 30) else (20 if (activity >= 5 and activity < 10) else (20 if (activity > 30 and activity <= 50) else (15 if activity < 5 else (10 if activity > 50 else 5)))) %}
          {% else %}
            {# Summer: High activity 60%+ optimal (foraging) #}
            {% set activity_score = 25 if activity >= 60 else (20 if activity >= 40 else (15 if activity >= 20 else (10 if activity >= 10 else 5))) %}
          {% endif %}
          
          {# WEIGHT SCORE (0-25 points) - SEASONAL #}
          {% if is_winter %}
            {# Winter: Stable weight ±0.1 kg/day is excellent #}
            {% set weight_score = 25 if (weight_change >= -0.1 and weight_change <= 0.1) else (20 if (weight_change > -0.3 and weight_change < -0.1) else (20 if (weight_change > 0.1 and weight_change <= 0.3) else (15 if (weight_change > -0.5 and weight_change <= -0.3) else (10 if weight_change > 0.3 else 5)))) %}
          {% else %}
            {# Summer: Weight gain >0.5 kg/day from nectar flow #}
            {% set weight_score = 25 if weight_change > 0.5 else (20 if weight_change > 0.1 else (15 if weight_change > -0.1 else (10 if weight_change > -0.5 else 5))) %}
          {% endif %}
          
          {# HUMIDITY SCORE (0-20 points) - COLORADO DRY CLIMATE #}
          {% if is_winter %}
            {# Winter in Colorado: 20-35% optimal (very dry climate) #}
            {% set humidity_score = 20 if (humidity >= 20 and humidity <= 35) else (15 if (humidity >= 15 and humidity <= 45) else (10 if (humidity >= 10 and humidity <= 50) else 5)) %}
          {% else %}
            {# Summer in Colorado: 30-40% optimal (still dry) #}
            {% set humidity_score = 20 if (humidity >= 30 and humidity <= 40) else (15 if (humidity >= 20 and humidity <= 50) else (10 if (humidity >= 15 and humidity <= 60) else 5)) %}
          {% endif %}
          
          {{ (temp_score + activity_score + weight_score + humidity_score) | round(0) }}
        attributes:
          season_mode: >
            {% set external_temp = states('sensor.broodminder_w_57_41_5e_temperature') | float(0) %}
            {{ 'Winter' if external_temp <= 50 else 'Summer' }}
          external_temperature: >
            {{ states('sensor.broodminder_w_57_41_5e_temperature') }}°F
          temperature_score: >
            {% set temp = states('sensor.broodminder_t_47_50_96_temperature') | float(0) %}
            {% set external_temp = states('sensor.broodminder_w_57_41_5e_temperature') | float(0) %}
            {% set is_winter = external_temp <= 50 %}
            {% if is_winter %}
              {{ 30 if (temp >= 50 and temp <= 70) else (25 if (temp >= 40 and temp < 50) else (20 if (temp > 70 and temp <= 80) else (15 if (temp >= 30 and temp < 40) else (10 if (temp > 80 and temp <= 90) else 5)))) }}
            {% else %}
              {{ 30 if (temp >= 93 and temp <= 95) else (25 if (temp >= 90 and temp <= 97) else (15 if (temp >= 85 and temp <= 100) else (10 if (temp >= 70 and temp < 85) else 5))) }}
            {% endif %}
          activity_score: >
            {% set activity = states('sensor.bee_hive_monitor_activity_score') | float(0) %}
            {% set external_temp = states('sensor.broodminder_w_57_41_5e_temperature') | float(0) %}
            {% set is_winter = external_temp <= 50 %}
            {% if is_winter %}
              {{ 25 if (activity >= 10 and activity <= 30) else (20 if (activity >= 5 and activity < 10) else (20 if (activity > 30 and activity <= 50) else (15 if activity < 5 else (10 if activity > 50 else 5)))) }}
            {% else %}
              {{ 25 if activity >= 60 else (20 if activity >= 40 else (15 if activity >= 20 else (10 if activity >= 10 else 5))) }}
            {% endif %}
          weight_score: >
            {% set weight_change = states('sensor.bee_hive_daily_weight_change') | float(0) %}
            {% set external_temp = states('sensor.broodminder_w_57_41_5e_temperature') | float(0) %}
            {% set is_winter = external_temp <= 50 %}
            {% if is_winter %}
              {{ 25 if (weight_change >= -0.1 and weight_change <= 0.1) else (20 if (weight_change > -0.3 and weight_change < -0.1) else (20 if (weight_change > 0.1 and weight_change <= 0.3) else (15 if (weight_change > -0.5 and weight_change <= -0.3) else (10 if weight_change > 0.3 else 5)))) }}
            {% else %}
              {{ 25 if weight_change > 0.5 else (20 if weight_change > 0.1 else (15 if weight_change > -0.1 else (10 if weight_change > -0.5 else 5))) }}
            {% endif %}
          humidity_score: >
            {% set humidity = states('sensor.broodminder_w_57_41_5e_humidity') | float(0) %}
            {% set external_temp = states('sensor.broodminder_w_57_41_5e_temperature') | float(0) %}
            {% set is_winter = external_temp <= 50 %}
            {% if is_winter %}
              {{ 20 if (humidity >= 20 and humidity <= 35) else (15 if (humidity >= 15 and humidity <= 45) else (10 if (humidity >= 10 and humidity <= 50) else 5)) }}
            {% else %}
              {{ 20 if (humidity >= 30 and humidity <= 40) else (15 if (humidity >= 20 and humidity <= 50) else (10 if (humidity >= 15 and humidity <= 60) else 5)) }}
            {% endif %}
          health_status: >
            {% set score = states('sensor.bee_hive_health_score') | float(0) %}
            {% if score >= 85 %}Excellent - Hive thriving!
            {% elif score >= 70 %}Good - Normal conditions
            {% elif score >= 50 %}Fair - Monitor closely
            {% elif score >= 30 %}Poor - Intervention may be needed
            {% else %}Critical - Immediate attention required
            {% endif %}
          scoring_explanation: >
            {% set external_temp = states('sensor.broodminder_w_57_41_5e_temperature') | float(0) %}
            {{ 'Winter mode active: Scoring adjusted for cluster temperatures (50-70°F optimal), low activity (10-30% good), stable weight, and dry climate (20-35% humidity optimal).' if external_temp <= 50 else 'Summer mode active: Scoring for brood-rearing temps (93-95°F optimal), high activity (60%+ excellent), nectar flow weight gain, and Colorado dry climate (30-40% humidity optimal).' }}

      # =====================================================================
      # NECTAR FLOW STATUS
      # =====================================================================
      - name: "Bee Hive Nectar Flow Status"
        unique_id: bee_hive_nectar_flow
        icon: mdi:flower-pollen
        state: >
          {% set weight_change = states('sensor.bee_hive_daily_weight_change') | float(0) %}
          {% set activity = states('sensor.bee_hive_monitor_activity_score') | float(0) %}
          {% if weight_change > 0.5 and activity > 60 %}Strong Nectar Flow
          {% elif weight_change > 0.2 and activity > 40 %}Moderate Nectar Flow
          {% elif weight_change > 0 and activity > 20 %}Light Nectar Flow
          {% elif weight_change < -0.2 %}No Flow - Consuming Stores
          {% else %}Stable - No Significant Flow
          {% endif %}
        attributes:
          daily_gain_kg: "{{ states('sensor.bee_hive_daily_weight_change') }}"
          daily_gain_lbs: "{{ (states('sensor.bee_hive_daily_weight_change') | float(0) * 2.20462) | round(2) }}"

      # =====================================================================
      # QUEEN HEALTH INDICATOR
      # =====================================================================
      - name: "Bee Hive Queen Health Indicator"
        unique_id: bee_hive_queen_health
        icon: mdi:crown
        state: >
          {% set temp = states('sensor.broodminder_t_47_50_96_temperature') | float(0) %}
          {% set activity = states('sensor.bee_hive_monitor_activity_score') | float(0) %}
          {% set weight_change = states('sensor.bee_hive_daily_weight_change') | float(0) %}
          {% set external_temp = states('sensor.broodminder_w_57_41_5e_temperature') | float(0) %}
          {% if temp >= 85 and temp <= 95 and activity < 20 and weight_change < 0.1 and external_temp > 60 %}
            Possible Queen Issue - Low activity with good conditions
          {% elif temp >= 90 and activity > 40 and weight_change > 0 %}
            Healthy - Good brood temp, activity, and foraging
          {% elif temp < 85 and external_temp < 50 %}
            Winter Mode - Normal low activity
          {% elif activity > 30 %}
            Normal - Active foraging
          {% else %}
            Monitor - Activity lower than expected
          {% endif %}
        attributes:
          brood_temp: "{{ states('sensor.broodminder_t_47_50_96_temperature') | float(0) | round(1) }}°F"
          activity: "{{ states('sensor.bee_hive_monitor_activity_score') | float(0) | round(1) }}%"
          weight_change: "{{ states('sensor.bee_hive_daily_weight_change') | float(0) | round(3) }} kg"
          external_temp: "{{ states('sensor.broodminder_w_57_41_5e_temperature') | float(0) | round(1) }}°F"

  # ===========================================================================
  # BINARY SENSORS
  # ===========================================================================
  - binary_sensor:
      - name: "Bee Hive Temperature Alert"
        unique_id: bee_hive_temp_alert
        device_class: problem
        state: >
          {% set temp = states('sensor.broodminder_t_47_50_96_temperature') | float(0) %}
          {% set high = states('input_number.bee_hive_temp_high_threshold') | float(100) %}
          {% set low = states('input_number.bee_hive_temp_low_threshold') | float(85) %}
          {{ temp > high or (temp < low and temp > 0) }}
        attributes:
          reason: >
            {% set temp = states('sensor.broodminder_t_47_50_96_temperature') | float(0) %}
            {% if temp > 100 %}
              Hive too hot ({{ temp | round(1) }}°F) - Check ventilation!
            {% elif temp < 85 and temp > 0 %}
              Hive too cold ({{ temp | round(1) }}°F) - Low brood activity
            {% else %}
              Normal
            {% endif %}
          current_temp: "{{ states('sensor.broodminder_t_47_50_96_temperature') | float(0) | round(1) }}°F"

      - name: "Bee Hive Nectar Flow Active"
        unique_id: bee_hive_nectar_flow_active
        device_class: running
        icon: mdi:flower-pollen
        state: >
          {% set weight_change = states('sensor.bee_hive_daily_weight_change') | float(0) %}
          {% set activity = states('sensor.bee_hive_monitor_activity_score') | float(0) %}
          {{ weight_change > 0.2 and activity > 40 }}

      - name: "Bee Hive Critical Health Alert"
        unique_id: bee_hive_critical_alert
        device_class: problem
        state: "{{ states('sensor.bee_hive_health_score') | float(100) < 30 }}"

      - name: "Bee Hive Robbing Detected"
        unique_id: bee_hive_robbing_detected
        device_class: problem
        state: >
          {% set weight_change = states('sensor.bee_hive_daily_weight_change') | float(0) %}
          {% set activity = states('sensor.bee_hive_monitor_activity_score') | float(0) %}
          {{ (weight_change < -0.5 and activity > 70) or (weight_change < -0.3 and activity > 50) }}

# =============================================================================
# STATISTICS SENSORS
# =============================================================================
sensor:
  # Bee Hive Activity Averages
  - platform: statistics
    name: "Bee Hive Activity (1h avg)"
    entity_id: sensor.bee_hive_monitor_activity_score
    state_characteristic: mean
    max_age:
      hours: 1
    sampling_size: 200

  - platform: statistics
    name: "Bee Hive Activity (24h avg)"
    entity_id: sensor.bee_hive_monitor_activity_score
    state_characteristic: mean
    max_age:
      hours: 24
    sampling_size: 1000

  - platform: statistics
    name: "Bee Hive Peak Activity Today"
    entity_id: sensor.bee_hive_monitor_activity_score
    state_characteristic: value_max
    max_age:
      hours: 24

  # Bee Hive Weight Averages
  - platform: statistics
    name: "Bee Hive Weight (24h avg)"
    entity_id: sensor.beehive_weight_compensated
    state_characteristic: mean
    max_age:
      hours: 24
    sampling_size: 1000

  - platform: statistics
    name: "Bee Hive Weight (7d avg)"
    entity_id: sensor.beehive_weight_compensated
    state_characteristic: mean
    max_age:
      days: 7
    sampling_size: 2000

  # Bee Hive Temperature Average
  - platform: statistics
    name: "Bee Hive Internal Temp (24h avg)"
    entity_id: sensor.broodminder_t_47_50_96_temperature
    state_characteristic: mean
    max_age:
      hours: 24
    sampling_size: 1000

  # Bee Hive Health Score Average
  - platform: statistics
    name: "Bee Hive Health Score (24h avg)"
    entity_id: sensor.bee_hive_health_score
    state_characteristic: mean
    max_age:
      hours: 24
    sampling_size: 1000
